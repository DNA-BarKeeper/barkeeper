<% provide(:title, @contig.name) %>
<%= show_val_errors(@contig)%>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Contig <%= @contig.name %>
      <% if @contig.try(:isolate).try(:individual).try(:species) %>
         - <%= link_to(@contig.isolate.individual.species.name_for_display, edit_species_path(@contig.isolate.individual.species.id)) %>
      <% end %>
    </h3>
  </div>
  <div class="panel-body">

    <%= form_for(@contig) do |f| %>

        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
          <li><a href="#description" role="tab" data-toggle="tab">Description</a></li>
          <li class="active"><a href="#assembly" role="tab" data-toggle="tab">Assembly</a></li>
          <li><a href="#downloads" role="tab" data-toggle="tab">Downloads</a></li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">

          <div class="tab-pane" id="description">
            <br>
            <div class="form-group">
              <%= f.label :name %>
              <%= f.text_field :name, class: 'form-control' %>
            </div>
            <div class="form-group">
              <%= f.label 'Isolate' %>
              <% if @contig.isolate %>
                  <%= link_to '', edit_isolate_path(@contig.isolate), :class => "glyphicon glyphicon-share-alt" %>
              <% end %>
              <%= f.text_field :isolate_name , data: {autocomplete_source: filter_isolates_path} , class: 'form-control'%>
            </div>


            <div class="form-group">
              <%= f.label 'Marker' %>

              <%= f.collection_select(:marker_id, Marker.all, :id, :name, include_blank: true) %>
              <% if @contig.marker %>
                  <%= link_to '', edit_marker_path(@contig.marker), :class => "glyphicon glyphicon-share-alt" %>
              <% end %>
            </div>

          </div>


          <div class="tab-pane active" id="assembly">
            <br>
            <span class="glyphicon glyphicon-align-center"></span> <%= link_to 'Assemble primer reads', overlap_contig_path %> | <%= link_to 'Assemble in background', overlap_background_contig_path %>
            <br>
            <div >
              <%= f.label :assembled, 'Assembly complete' %>
              <%= f.check_box :assembled  %>
            </div>
            <div class="form-group">
              <%= f.label 'Marker Sequence' %>
              <% if @contig.marker_sequence %>
                  <%= link_to '', edit_marker_sequence_path(@contig.marker_sequence), :class => "glyphicon glyphicon-share-alt" %>
              <% end %>
              <%= f.text_field :marker_sequence_name , data: {autocomplete_source: filter_marker_sequences_path} , class: 'form-control'%>
            </div>

            <div >
              <% if @contig.verified_by %>
                  <%begin%>
                      <%user= User.find(@contig.verified_by).name %>
                  <%rescue%>
                      <% user= '?'%>
                  <%end%>
                  Verified by <%=  user %> on <%= @contig.verified_at.in_time_zone("CET").strftime("%Y-%m-%d %H:%M:%S")%>. <%= link_to '(Remove)', verify_contig_path(@contig) %><br><br>
              <% else %>
                  <%= link_to verify_contig_path(@contig) do %>
                      <span class = "glyphicon glyphicon-ok"></span> Verify
            <% end %>
                      <br><br>
              <% end %>

            </div>

          </div>


          <div class="tab-pane" id="downloads">
            <br>
            <div class="form-group"><span class="glyphicon glyphicon-arrow-down"></span><%= link_to ' Download aligned sequences as PDE file',  pde_contig_path %><br>
              <span class="glyphicon glyphicon-arrow-down"></span><%= link_to ' Download aligned sequences as Fasta file',  fasta_contig_path %><br>
              <span class="glyphicon glyphicon-arrow-down"></span><%= link_to ' Download trimmed sequences as Fasta file',  fasta_trimmed_contig_path %><br>
              <span class="glyphicon glyphicon-arrow-down"></span><%= link_to ' Download raw sequences as Fasta file',  fasta_raw_contig_path %><br></div>
          </div>
        </div>
        <%= f.submit 'Update', :class =>  'btn btn-default'%>



    <% end %>


    <div class="alignment">

      <%= content_tag "div", id: "contig", data: {url: @contig.partial_cons.includes(:primer_reads) } do %>


      <% end %>

    </div>

    <!-- to be used but not assembled-->

    <% failures=@contig.primer_reads.where("used_for_con = ? AND assembled = ?", true, false)%>

    <% if failures.any? %>
        <hr>
        <p><b>Assigned reads not yet assembled:</b></p>
        <% for i in 0...failures.length %>
            <% pr= failures[i] %>

            <!--single chromatogram view-->
            <%= link_to pr.name, edit_primer_read_path(pr) %>
            <hr>

            <div class="alignment" id="chromatogram_container">

              <%= content_tag "div", id: "chromatogram", data: {url: pr } do %>

              <% end %>

            </div>
            <!--end chromatogram div -->
            <br>
        <% end %>
    <% end %>

    <!-- not to be used -->
    <% dontuse=@contig.primer_reads.where(:used_for_con => false) %>

    <% if dontuse.any? %>
        <br>Excluded Reads:<br>
        <% for i in 0...dontuse.length %>
            <% pr= dontuse[i] %>
            <%= link_to pr.name, edit_primer_read_path(pr) %><br>
        <% end %>
    <% end %>

  </div>
</div>
</div>
